<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap");
    body {
      background: #ffffff;
      font-family: "Open Sans";
      margin: 0;
      padding: 0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    [contenteditable="true"] {
      background-color: inherit;
      border: none;
      cursor: auto;
    }

    .container {
      display: flex;
      height: 100vh;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      align-items: center;
    }
    .sidebar {
      display: flex;
      align-items: center;
      flex-direction: column;
      width: 260px;
      background: #f4f7f9;
      border-radius: 10px;
      height: 782px;
    }
    .chat-container {
      flex: 1;
      display: flex;
      max-width: 780px;
      max-height: 782px;
      min-height: 782px;
      background: rgba(216, 227, 234, 0.3);
      border-radius: 10px;
    }

    .chat-area {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .chat-header {
      height: 80px;
      width: 100%;
      display: flex;
      background-color: #d6e3ed;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      flex-direction: column;
      justify-content: center;
      align-self: center;
    }

    .chat-header .user-head-info {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .user-text-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .chat-name {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      line-height: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #313232;
      cursor: pointer;
    }

    .chat-last-info {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-size: 8px;
      line-height: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(49, 50, 50, 0.8);
      cursor: pointer;
    }

    .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    /* INPUT */

    .message-input {
      display: flex;
      position: relative;
      padding: 10px;
      background-color: #d6e3ed;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      align-items: center;
    }
    .message-input textarea {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 10px;
      width: 100%;
      min-height: 40px;
      max-height: 100px;
      background: #ffffff;
      white-space: pre-wrap;
      overflow-x: hidden;
      overflow-y: auto;
      resize: none;
      box-sizing: border-box;
      padding-right: 90px;
      font-family: "Open Sans", sans-serif;
      font-style: normal;
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.05em;
      outline: none;
      transition: height 0.3s;
    }
    .input_button_container {
      display: flex;
      gap: 20px;
      position: absolute;
      right: 30px;
      top: 50%;
      transform: translateY(-50%);
    }
    .message-input button {
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: none;
      padding: 0px;
    }

    #addFileToMessage {
      padding-right: 20px;
      height: 30px;
    }

    @keyframes im-zoom-hide {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      49% {
        opacity: 1;
        transform: scale(0.1);
      }
      50% {
        opacity: 0;
        transform: scale(0.1);
      }
      100% {
        opacity: 0;
        transform: scale(0.1);
      }
    }

    @keyframes im-zoom-appear {
      0% {
        transform: scale(0.1);
        opacity: 0;
      }
      50% {
        transform: scale(0.1);
        opacity: 0;
      }
      51% {
        transform: scale(0.1);
        opacity: 1;
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .hidden {
      display: none;
    }

    #sendMessageButton.zoom-hide {
      animation: 0.1s linear 0s im-zoom-hide;
      opacity: 0;
    }

    #sendMessageButton.zoom-appear {
      animation: 0.1s linear 0s im-zoom-appear;
      opacity: 1;
    }

    /* MESSAGE */

    .messages {
      display: flex;
      flex-direction: column;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    .message {
      max-width: 70%;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      color: #2b2d2f;
      word-wrap: break-word;
      box-sizing: border-box;
    }
    .message.sent {
      background-color: #dee9f1;
      margin-left: auto;
      border-top-right-radius: 0px;
    }
    .message.received {
      background-color: #d6e3ed;
      margin-right: auto;
      border-top-left-radius: 0px;
    }
    .message-content {
      display: flex;
      flex-direction: column;
    }
    .message-text {
      margin-bottom: 10px;
    }
    .message-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 5px;
    }
    .message-images img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 5px;
    }
    .message-file {
      display: flex;
      align-items: center;
      /* background-color: #f0f0f0; */
      padding: 5px;
      border-radius: 5px;
      margin-top: 5px;
    }
    .message-file img {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }

    .title_h1_text_chat {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      line-height: 16px;
      text-align: center;
      letter-spacing: 0.05em;
      text-transform: uppercase;

      color: #313232;
    }

    .title_h2_text_chat {
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-size: 8px;
      line-height: 16px;
      text-align: center;
      letter-spacing: 0.05em;
      text-transform: uppercase;

      color: #313232;
    }

    .chat-filter-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      padding-top: 5px;
    }

    .search-container {
      display: flex;
      align-items: center;
      padding: 4px;
      width: 206px;
      background: #d6e3ed;
      border-radius: 10px;
      margin-top: 20px;
    }

    .search-container input[type="text"] {
      flex: 1;
      border: none;
      outline: none;
      background: #d6e3ed;
      padding-left: 10px;

      font-family: "Open Sans";
      font-style: normal;
      font-weight: 600;
      font-size: 12px;
      line-height: 16px;
      letter-spacing: 0.05em;

      color: rgba(43, 45, 47, 0.6);
    }

    .search-container button[type="submit"] {
      border: none;
      outline: none;
      background-color: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding-right: 10px;
    }

    .search-container button[type="submit"] img {
      width: 16px;
      height: 16px;
      margin: auto;
    }

    #chatList {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0;
      gap: 10px;
      flex-direction: column;
      padding-top: 20px;
    }

    .chat-room_item {
      display: flex;
      align-items: center;
      width: 220px;
      height: 60px;
      background-color: #d6e3ed;
      border-radius: 10px;
      padding-left: 20px;
      transition: 0.15s;
    }

    .chat-room-title {
      display: flex;
      gap: 11px;
    }

    .chat_room_link {
      text-decoration: none;
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 700;
      font-size: 10px;
      line-height: 14px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #2b2d2f;

      padding-top: 5px;
    }

    .chat_room_name_role {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-room_item:hover {
      background-color: #acbfca;
      cursor: pointer;
    }

    .dropdown {
      position: relative;
      left: 255px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #d6e3ed;
      min-width: 141px;
      box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.45);
      border-radius: 10px;
    }

    .dropdown-content a {
      padding: 0px 5px;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-family: "Open Sans";
      font-style: normal;
      font-weight: 600;
      font-size: 12px;
      line-height: 16px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.8);
    }

    .dropdown-content a:first-child {
      margin-top: 10px;
    }

    .dropdown-content a:last-child {
      margin-bottom: 10px;
    }

    .dropdown-content a:hover {
      background-color: #bdccd4;
      box-shadow: 0px 2px 4px rgba(172, 191, 202, 0.5);
      border-radius: 10px;
    }

    .dropdown-content a:active {
      background-color: #acbfca;
      box-shadow: 0px 2px 4px rgba(172, 191, 202, 0.5);
      border-radius: 10px;
    }

    .dropdown-content img {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }

    .visible {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }


    /* POPUP */

    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .popup {
      background-color: #F3F7F9;
      width: 380px;
      min-height: 380px;
      border-radius: 10px;
      padding: 20px;
      position: relative;
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .popup.active {
      opacity: 1;
      transform: scale(1);
    }
    .close-popup {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    .popup_title_text {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      line-height: 16px;
      text-transform: uppercase;
      color: #313232;
    }

    .popup_info_room_name {
      display: flex;
      align-items: center;
      gap: 17px;
      padding-top: 15px;
    }

    .room_group_name_count {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .room_group_name {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 14px;
      color: #313232;
    }

    .room_group_count {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 10px;
      color: rgba(49, 50, 50, 0.8);
    }

    .popup_room_member_type_tab {
      display: flex;
      padding-top: 26px;
      justify-content: space-between;
      align-items: center;
    }

    .type_tabs {
      display: flex;
      flex-direction: row;
      gap:30px;
    }

    .popup_tab_all_members, .popup_tab_moderators, .add_member_label {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 10px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #313232;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .popup_tab_all_members.active, .popup_tab_moderators.active {
      color: #6A8EA6;
    }

    #search_member_btn, #add_member_btn, .close-popup {
      border: none;
      outline: none;
      background-color: transparent;
      cursor: pointer;
    }

    .add_member_to_room_container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding-top: 22px;
    }

    .add_member_to_room_container.hidden {
      display: none;
    }

    .popup_member_list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      list-style: none;
      padding-top: 22px;
    }

    .popup_member_item {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-direction: row;
    }

    .popup_member_img {
      height: 40px;
    }

    .popup_member_info_outer_container {
      display: flex;
      flex-direction: column;
    }

    .popup_member_name {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #313232;
    }

    .popup_member_last_activity {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 8px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(49, 50, 50, 0.8);
    }

    .popup_member_role {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 600;
      font-size: 12px;
      color: rgba(43, 45, 47, 0.6);
    }

    .popup_lower_part {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 23px;
      padding-top: 32px;
    }

    .show-all-toggle {
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      text-align: center;
      color: rgba(49, 50, 50, 0.8);
    }

    .add-member-button {
      width: 150px;
      height: 36px;
      background: #6A8EA6;
      color: #FFF;
      border-radius: 10px;
      border: none;
      outline: none;
      cursor: pointer;
      font-family: 'Open Sans';
      font-style: normal;
      font-weight: 700;
      font-size: 12px;
      text-align: center;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .user-status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .online {
      background-color: green;
    }
    .offline {
      background-color: red;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="chat-container">
    <div class="chat-area">
      <div class="chat-header">
        <div class="user-head-info">
          <img th:src="@{/svg/chat_room_img.svg}" alt="buddy" class="chat-man-logo" />
          <div class="user-text-info">
            <span class="chat-name"></span>
            <span class="chat-last-info"></span>
          </div>
          <div class="dropdown">
            <input onclick="toggleDropdown()" type="image" class="modal-chat-info" th:src="@{/svg/more_dots.svg}" />
            <div id="dropdownMenu" class="dropdown-content">
              <a href="#" onclick="infoModal()">
                <img th:src="@{/svg/info.svg}" alt="Info" /> Информация
              </a>
              <a href="#">
                <img th:src="@{/svg/poll.svg}" alt="Poll" /> Опрос
              </a>
              <a href="#">
                <img th:src="@{/svg/export.svg}" alt="Export" /> Экспорт
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="messages" id="messages">
        <!-- Динамическое заполнение сообщений -->
      </div>
      <div class="message-input">
        <button type="button" id="addFileToMessage">
          <img th:src="@{/svg/addToMessage.svg}" alt="add" />
        </button>
        <textarea id="messageInput" placeholder="Напишите сообщение" rows="1"></textarea>
        <div class="input_button_container">
          <button type="button">
            <img th:src="@{/svg/smile.svg}" class="bi bi-smile" alt="smile" />
          </button>
          <button type="button" id="sendMessageButton" onclick="sendVoiceMessage()">
            <img th:src="@{/svg/mic.svg}" alt="mic" />
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="sidebar">
    <h1 class="title_h1_text_chat" style="padding-top: 40px">Доступные чаты</h1>
    <div class="chat-filter-container">
      <h2 class="title_h2_text_chat">Все пользователи</h2>
      <img th:src="@{/svg/down_icon.svg}" alt="down_icon" />
    </div>
    <div class="search-container">
      <input type="text" placeholder="Найти пользователя" />
      <button type="submit" id="search-button">
        <img th:src="@{/svg/search.svg}" alt="Search" />
      </button>
    </div>
    <ul id="chatList">
      <!-- Динамическое заполнение чатов -->
    </ul>
  </div>
</div>
<div class="popup-overlay">
  <div class="popup">
    <button class="close-popup">
      <img th:src="@{/svg/close-pic.svg}" alt="close">
    </button>
    <h1 class="popup_title_text">Информация</h1>
    <div class="popup_info_room_name">
      <img th:src="@{/svg/popup_room_pic.svg}" alt="room_pic">
      <div class="room_group_name_count">
        <div class="room_group_name"></div>
        <div class="room_group_count"></div>
      </div>
    </div>
    <div class="popup_room_member_type_tab">
      <div class="type_tabs">
        <div class="popup_tab_all_members">Все участники</div>
        <div class="popup_tab_moderators">Администраторы</div>
      </div>
      <button type="button" id="search_member_btn">
        <img th:src="@{/svg/search_member_to_add.svg}" alt="search_member">
      </button>
    </div>
    <div class="add_member_to_room_container">
      <button type="button" id="add_member_btn">
        <img th:src="@{/svg/add_member_to_group.svg}" alt="add_member">
      </button>
      <div class="add_member_label">Добавить участников</div>
    </div>
    <ul class="popup_member_list collapsed" id="popupMemberList">
      <!-- Динамическое заполнение списка пользователей -->
    </ul>
    <div class="popup_lower_part">
      <button type="submit" class="add-member-button">
        Выйти из чата
      </button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
  var stompClient = null;
  var currentRoomId = null;
  var currentUsername = '';
  var currentRecipients = [];


  function getCurrentUser() {
    fetch('/api/users/current')
            .then(response => {
              if (response.status === 401) {
                window.location.href = '/login';
              }
              return response.json();
            })
            .then(data => {
              currentUsername = data.username;
            })
            .catch(error => console.error('Error fetching current user:', error));
  }


  function connect() {
    var socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
      loadRooms();
      getCurrentUser();
      subscribeToUserStatus();
      sendUserStatus('ONLINE');
      updateRoomDetails(roomId);
    });
  }

  function sendUserStatus(status) {
    if (stompClient && currentUsername) {
      stompClient.send("/app/user.status", {}, JSON.stringify({username: currentUsername, status: status}));
    }
  }


  function loadRooms() {
    fetch('/api/rooms')
            .then(response => {
              if (response.status === 401) {
                window.location.href = '/login';
              }
              return response.json();
            })
            .then(data => {
              const chatList = document.getElementById('chatList');
              chatList.innerHTML = '';
              data.forEach(room => {
                const li = document.createElement('li');
                li.className = 'chat-room_item';
                li.onclick = () => joinRoom(room.id);
                li.innerHTML = `
                            <div class="chat-room-title">
                                <div class="chat_room_name_role">
                                    <span class="chat_room_link">${room.name}</span>
                                </div>
                            </div>
                        `;
                chatList.appendChild(li);
              });
            });
  }

  function loadMessages(roomId) {
    fetch(`/api/messages/room/${roomId}`)
            .then(response => response.json())
            .then(messages => {
              const messagesDiv = document.getElementById('messages');
              messagesDiv.innerHTML = '';
              messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                if (message.sender === currentUsername) {
                  messageDiv.classList.add('sent');
                } else {
                  messageDiv.classList.add('received');
                }
                messageDiv.textContent = `${message.sender}: ${message.content}`;
                messagesDiv.appendChild(messageDiv);
              });
            });
  }


  function joinRoom(roomId) {
    if (currentRoomId) {
      stompClient.unsubscribe(currentRoomId);
    }
    currentRoomId = roomId;
    stompClient.subscribe(`/topic/${roomId}`, function (messageOutput) {
      showMessageOutput(JSON.parse(messageOutput.body));
    });
    document.getElementById('messages').innerHTML = '';
    fetch(`/api/rooms/${roomId}`)
            .then(response => response.json())
            .then(room => {
              currentRecipients = room.userIds.filter(userId => userId !== currentUsername);
              loadMessages(roomId);
              loadRoomUsers(roomId);
              updateUrl(roomId);
              updateRoomDetails(roomId);
            });
  }

  function updateRoomDetails(roomId) {
    fetch(`/api/rooms/${roomId}/details`)
            .then(response => response.json())
            .then(data => {
              document.querySelector('.chat-name').textContent = data.name;
              document.querySelector('.chat-last-info').textContent = `${data.userCount} участника`;
              document.querySelector('.room_group_name').textContent = data.name;
              document.querySelector('.room_group_count').textContent = `${data.userCount} участника`;

              const userList = document.getElementById('popupMemberList');
              userList.innerHTML = '';
              data.users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user.username;
                userList.appendChild(li);
              });
            })
            .catch(error => console.error('Error fetching room details:', error));
  }


  function updateUrl(roomId) {
    history.pushState(null, '', `/chatroom?sel=${roomId}`);
  }

  function loadRoomUsers(roomId) {
    fetch(`/api/rooms/${roomId}/users`)
            .then(response => response.json())
            .then(users => {
              updateUserList(users);
            });
  }

  function subscribeToUserStatus() {
    stompClient.subscribe('/topic/user.status', function (statusOutput) {
      updateUserStatus(JSON.parse(statusOutput.body));
    });
  }

  function updateUserStatus(statusUpdate) {
    const userElement = document.querySelector(`#userList li[data-username="${statusUpdate.username}"]`);
    if (userElement) {
      const statusElement = userElement.querySelector('.user-status');
      statusElement.className = `user-status ${statusUpdate.status.toLowerCase()}`;
    }
  }


  function updateUserList(users) {
    let userList = document.getElementById('userList');

    if (!userList) {
      userList = document.createElement('ul');
      userList.id = 'userList';
      document.body.appendChild(userList);
    }

    userList.innerHTML = '';

    users.forEach(user => {
      const li = document.createElement('li');
      li.setAttribute('data-username', user.username);
      const statusSpan = document.createElement('span');
      statusSpan.className = `user-status ${user.status.toLowerCase()}`;
      li.appendChild(statusSpan);
      li.appendChild(document.createTextNode(user.username));
      userList.appendChild(li);
    });
  }


  function sendMessage() {
    var messageContent = document.getElementById('messageInput').value.trim();
    if (messageContent && stompClient && currentRoomId) {
      var chatMessage = {
        sender: currentUsername,
        content: messageContent,
        roomId: currentRoomId,
        recipients: currentRecipients
      };
      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
      document.getElementById('messageInput').value = '';
      adjustTextareaHeight();
    }
  }


  function showMessageOutput(messageOutput) {
    var messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    if (messageOutput.sender === currentUsername) {
      messageDiv.classList.add('sent');
    } else {
      messageDiv.classList.add('received');
    }
    messageDiv.textContent = `${messageOutput.sender}: ${messageOutput.content}`;
    document.getElementById('messages').appendChild(messageDiv);
  }

  function handleKeyPress(event) {
    if (event.key === "Enter") {
      sendMessage();
    }
  }


  window.onload = function () {
    connect();
  };

  window.onbeforeunload = function() {
    sendUserStatus('OFFLINE');
  };
</script>

<script>
  var inactivityTime = function () {
    var time;
    window.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeypress = resetTimer;
    document.onscroll = resetTimer;
    document.onmousedown = resetTimer;
    document.ontouchstart = resetTimer;

    function logout() {
      sendUserStatus('OFFLINE');
    }

    function resetTimer() {
      clearTimeout(time);
      sendUserStatus('ONLINE');
      time = setTimeout(logout, 10000);
    }
  };

  window.onload = function () {
    connect();
    inactivityTime();
  };

  window.onbeforeunload = function() {
    sendUserStatus('OFFLINE');
  };

</script>

<script>
  const searchButton = document.getElementById("search-button");
  const searchInput = document.querySelector('input[type="text"]');
  const searchIcon = searchButton.querySelector("img");

  function toggleSearchIcon() {
    searchIcon.src =
            searchInput.value.length > 0 ? "/svg/close-pic.svg" : "/svg/search.svg";
  }

  searchInput.addEventListener("input", toggleSearchIcon);

  searchButton.addEventListener("click", function () {
    if (searchInput.value.length > 0) {
      searchInput.value = "";
      toggleSearchIcon();
    }
  });
</script>

<script>
  function infoModal() {
    const modal = document.getElementById("myModal");
    modal.style.display = "flex";
    const span = document.getElementsByClassName("close")[0];
    span.onclick = function () {
      modal.style.display = "none";
    };
  }

  function toggleDropdown() {
    document.getElementById("dropdownMenu").classList.toggle("visible");
  }

  window.onclick = function (event) {
    if (!event.target.matches(".modal-chat-info")) {
      var dropdowns = document.getElementsByClassName("dropdown-content");
      for (var i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains("visible")) {
          openDropdown.classList.remove("visible");
        }
      }
    }
  };
</script>

<script>
  const textarea = document.getElementById("messageInput");
  const sendButton = document.getElementById("sendMessageButton");

  function adjustTextareaHeight() {
    textarea.style.height = "auto";
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + "px";
  }

  textarea.addEventListener("input", adjustTextareaHeight);

  textarea.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const messageInput = document.getElementById("messageInput");
    const sendMessageButton = document.getElementById("sendMessageButton");
    let isTextMode = false;

    messageInput.addEventListener("input", function () {
      const currentValue = messageInput.value.trim();
      if (currentValue !== "" && !isTextMode) {
        isTextMode = true;
        sendMessageButton.classList.remove("zoom-appear");
        sendMessageButton.classList.add("zoom-hide");
        setTimeout(() => {
          sendMessageButton.classList.remove("zoom-hide");
          sendMessageButton.innerHTML = '<img src="/svg/send.svg" alt="send">';
          sendMessageButton.setAttribute("onclick", "sendMessage()");
          sendMessageButton.classList.add("zoom-appear");
        }, 60);
      } else if (currentValue === "" && isTextMode) {
        isTextMode = false;
        sendMessageButton.classList.remove("zoom-appear");
        sendMessageButton.classList.add("zoom-hide");
        setTimeout(() => {
          sendMessageButton.classList.remove("zoom-hide");
          sendMessageButton.innerHTML = '<img src="/svg/mic.svg" alt="mic">';
          sendMessageButton.setAttribute("onclick", "sendVoiceMessage()");
          sendMessageButton.classList.add("zoom-appear");
        }, 60);
      }
    });
  });
</script>

<script>
  function adjustMessageLayout() {
    const messages = document.querySelectorAll(".message");
    messages.forEach((message) => {
      const content = message.querySelector(".message-content");
      const imagesContainer = message.querySelector(".message-images");
      const images = message.querySelectorAll(".message-images img");

      Promise.all(
              Array.from(images).map((img) => {
                if (img.complete) return Promise.resolve();
                return new Promise((resolve) => {
                  img.onload = img.onerror = resolve;
                });
              })
      ).then(() => {
        if (images.length > 0) {
          let columns;
          if (images.length === 1) columns = 1;
          else if (images.length <= 4) columns = 2;
          else if (images.length <= 9) columns = 3;
          else columns = 4;

          imagesContainer.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }

        const maxWidth = message.parentElement.offsetWidth * 0.7;
        const contentWidth = content.offsetWidth;

        if (contentWidth < maxWidth) {
          message.style.width = "auto";
        } else {
          message.style.width = "70%";
        }
      });
    });
  }

  window.addEventListener("load", adjustMessageLayout);
  window.addEventListener("resize", adjustMessageLayout);
</script>

<script>
  const chatUserName = document.querySelector('.chat-name');
  const chatLastInfo = document.querySelector('.chat-last-info');
  const popupOverlay = document.querySelector('.popup-overlay');
  const popup = document.querySelector('.popup');
  const closePopup = document.querySelector('.close-popup');

  function openPopup() {
    popupOverlay.style.display = 'flex';
    setTimeout(() => {
      popup.classList.add('active');
    }, 10);
  }

  function closePopupFunction() {
    popup.classList.remove('active');
    setTimeout(() => {
      popupOverlay.style.display = 'none';
    }, 300);
  }

  chatUserName.addEventListener('click', openPopup);
  chatLastInfo.addEventListener('click', openPopup);
  closePopup.addEventListener('click', closePopupFunction);
  popupOverlay.addEventListener('click', (e) => {
    if (e.target === popupOverlay) {
      closePopupFunction();
    }
  });
</script>

<script>

  const memberList = document.querySelector('.popup_member_list');
  const showAllToggle = document.querySelector('.show-all-toggle');
  const tabAllMembers = document.querySelector('.popup_tab_all_members');
  const tabModerators = document.querySelector('.popup_tab_moderators');
  const addMemberContainer = document.querySelector('.add_member_to_room_container');
  function switchTab(tab) {
    tabAllMembers.classList.remove('active');
    tabModerators.classList.remove('active');
    tab.classList.add('active');

    if (tab === tabAllMembers) {
      addMemberContainer.classList.remove('hidden');
      memberList.querySelectorAll('.popup_member_item').forEach(item => item.style.display = '');
    } else {
      addMemberContainer.classList.add('hidden');
      memberList.querySelectorAll('.popup_member_item').forEach(item => {
        if (item.querySelector('.popup_member_role').textContent !== 'Администратор') {
          item.style.display = 'none';
        } else {
          item.style.display = '';
        }
      });
    }
  }

  tabAllMembers.addEventListener('click', () => switchTab(tabAllMembers));
  tabModerators.addEventListener('click', () => switchTab(tabModerators));
</script>
</body>
</html>